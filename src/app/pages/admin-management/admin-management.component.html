<div
  *ngIf="userService.currentUser$ | async as user"
  class="w-full flex flex-column gap-2"
>
  <h1 class="page-h1">Your Profile</h1>
  <p-card class="w-full">
    <div class="flex flex-row justify-content-between p-2">
      <div class="flex flex-column">
        <div class="text-xl font-bold text-green-800">
          {{ user.username || "" }}
        </div>
        <div class="text-xs font-light text-color-secondary">
          <i class="pi pi-envelope pr-1" style="font-size: x-small"></i>
          {{ user.email || "" }}
        </div>
      </div>
      <div class="flex flex-row gap-2">
        <button
          pButton
          icon="pi pi-lock"
          severity="secondary"
          [raised]="true"
          (click)="onResetPassword()"
          [disabled]="isResetDisable"
        >
          Reset Password
        </button>
        <button
          pButton
          icon="pi pi-sign-out"
          severity="danger"
          (click)="onLogout()"
        >
          Sign Out
        </button>
      </div>
    </div>
  </p-card>
  <div *ngIf="user.is_superadmin">
    <div class="flex flex-row justify-content-between align-items-center">
      <h2 class="page-h2">Admin Management</h2>
      <button
        pButton
        icon="pi pi-plus"
        size="small"
        (click)="toggleCreateAdminDialogVisibility()"
      >
        Create Admin
      </button>
    </div>
    <div class="surface-100 border-round p-3" *ngIf="!isAdminListLoading, else loading">
    @if (admins.length <= 0) { No admins yet. } @else {
    <p-table [value]="admins" [paginator]="true" [rows]="10">
      <ng-template #header>
        <tr>
          <th>No.</th>
          <th>Username</th>
          <th>Email</th>
          <th></th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-admin let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ admin.username }}</td>
          <td>{{ admin.email }}</td>
          <td>
            <p-badge
              value="Super admin"
              severity="success"
              badgeSize="small"
              *ngIf="admin.is_superadmin"
            ></p-badge>
          </td>
          <td>
            <span class="flex flex-row gap-2">
              <!-- <p-button icon="pi pi-file-edit" [rounded]="true" [outlined]="true" size="small" (onClick)="onEditState(rowIndex)"></p-button> -->
              <p-button icon="pi pi-trash" [rounded]="true" [outlined]="true" severity="danger" size="small" (onClick)="dialogService.openConfirmDeleteDialog(onDeleteAdmin.bind(this, admin.uid))" [disabled]="hasAction" *ngIf="user.uid !== admin.uid"></p-button>
            </span>
          </td>
        </tr>
      </ng-template>
    </p-table>
    }
    </div>
    <ng-template #loading>
      <p-skeleton width="100%" height="4rem" />
    </ng-template>
  </div>
</div>

<p-dialog header="Create Admin" [modal]="true" [(visible)]="visible" (onHide)="resetCreateAdminForm()">
  <form [formGroup]="createAdminForm" (ngSubmit)="onCreateAdmin()"> 
    <div class="flex flex-column align-items-start gap-1 mb-4">
      <label for="username" class="font-semibold">Username</label>
      <input pInputText id="username" formControlName="username" class="w-full" />
      @if (isFieldInvalid('username')) {
        <span class="text-red-500 text-xs" *ngIf="createAdminForm.get('username')?.errors?.['required']">Username is required</span>
      } 
    </div>
    <div class="flex flex-column align-items-start gap-1 mb-4">
      <label for="email" class="font-semibold">Email</label>
      <input pInputText id="email" formControlName="email" class="w-full" />
      @if (isFieldInvalid('email')) {
        <span class="text-red-500 text-xs" *ngIf="createAdminForm.get('email')?.errors?.['required']">Email is required</span>
        <span class="text-red-500 text-xs" *ngIf="createAdminForm.get('email')?.errors?.['email']">Invalid email</span>
      } 
    </div>
    <div class="flex flex-column align-items-start gap-1 mb-4">
      <label for="password" class="font-semibold">Password</label>
      <span class="p-text-secondary text-xs font-light">This password is a temporary password. Admin is required to renew password when logged in.</span>
      <input pInputText id="password" formControlName="password" class="w-full" />
      @if (isFieldInvalid('password')) {
        <span class="text-red-500 text-xs">
          @if (createAdminForm.get('password')?.hasError('required')) {
            This field is required
          } @else if (createAdminForm.get('password')?.hasError('digit')) {
            Must include at least one digit
          } @else if (createAdminForm.get('password')?.hasError('upperLower')) {
            Must include at least one uppercase and one lowercase
          } @else if (createAdminForm.get('password')?.hasError('specialChar')) {
            Must include at least one special character (e.g., ! &#64; # $ % ^ & *)
          } @else if (createAdminForm.get('password')?.hasError('minlength')) {
            Must be at least 8 characters long
          }
        </span>
      }
    </div>
    <div class="flex flex-row justify-content-between gap-2 mb-4">
      <label for="is_superadmin" class="font-semibold">Super admin</label>
      <p-toggleswitch id="is_superadmin" formControlName="isSuperadmin" ></p-toggleswitch>
    </div>
    <div class="flex justify-content-end gap-2">
        <p-button label="Cancel" severity="secondary" (click)="toggleCreateAdminDialogVisibility()" [disabled]="isFormLoading" />
        <p-button label="Create" type="submit" [loading]="isFormLoading" />
    </div>
  </form>
</p-dialog>

<p-toast></p-toast>
